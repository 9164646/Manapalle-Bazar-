<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Manapalle Bazar - Lucky Draw</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0"></script>
</head>
<body style="background: #000; color: #fff; font-family: Arial, sans-serif; padding: 20px;">

<h1 class="text-center mb-4" style="color: #FFD700; text-shadow: 2px 2px 10px #FFD700;">Manapalle Bazar - Lucky Draw</h1>

<!-- Navigation -->
<div id="navigation" class="text-center mb-4">
    <button class="btn btn-warning m-2" onclick="showSection('userList')">User List</button>
    <button class="btn btn-warning m-2" onclick="showSection('addUserSection')">Add User</button>
    <button class="btn btn-warning m-2" onclick="showSection('winnerList')">Winners</button>
    <button class="btn btn-warning m-2" onclick="drawWinner()">Draw Winner</button>
    <button class="btn btn-danger m-2" onclick="resetData()">Reset Data</button>
    <button id="logoutBtn" class="btn btn-danger m-2 hidden" onclick="logoutAdmin()">Logout</button>
</div>

<style>
    .hidden { display: none; }
    .btn-warning { transition: 0.2s; }
    .btn-warning:hover { transform: scale(1.1); box-shadow: 0 0 15px #FFD700; }
    .winner-highlight {
        color: #FFD700;
        font-size: 24px;
        text-shadow: 0 0 20px #FFD700;
        animation: glow 1.5s infinite;
    }
    @keyframes glow {
        0%, 100% { text-shadow: 0 0 5px #FFD700; }
        50% { text-shadow: 0 0 20px #FFD700; }
    }
</style>

<!-- Winner Announcement -->
<div id="winnerSection" class="text-center hidden">
    <h2>Latest Winner</h2>
    <div id="winnerDisplay" class="winner-highlight"></div>
</div>

<!-- User List -->
<div id="userList" class="hidden">
    <h2>Registered Users</h2>
    <table class="table table-dark table-hover">
        <thead><tr><th>S. No</th><th>Name</th><th>Coupon Code</th><th>Action</th></tr></thead>
        <tbody id="userTableBody"></tbody>
    </table>
</div>

<!-- Add User Section -->
<div id="addUserSection" class="hidden">
    <h2>Add User</h2>
    <input type="text" id="userName" placeholder="User Name" class="form-control mb-2">
    <input type="text" id="userMobile" placeholder="Mobile Number" class="form-control mb-2">
    <button class="btn btn-warning" onclick="addUser()">Add User</button>
</div>

<!-- Winner List -->
<div id="winnerList" class="hidden">
    <h2>Winners</h2>
    <button class="btn btn-success mb-2" onclick="exportToCSV('winners')">Export Winners</button>
    <table class="table table-dark">
        <thead><tr><th>List No</th><th>Name</th><th>Coupon Code</th><th>Prize</th></tr></thead>
        <tbody id="winnersTableBody"></tbody>
    </table>
</div>

<!-- Admin Login -->
<div id="adminLogin" class="text-center">
    <h2>Admin Login</h2>
    <input type="password" id="adminPassword" placeholder="Enter Password" class="form-control mb-2">
    <button class="btn btn-warning" onclick="validateAdmin()">Login</button>
</div>

<script>
    // Data Handling
    let users = JSON.parse(localStorage.getItem('users')) || [];
    let winners = JSON.parse(localStorage.getItem('winners')) || [];
    let listNumber = JSON.parse(localStorage.getItem('listNumber')) || 1;
    let isAdmin = sessionStorage.getItem('isAdmin') === 'true';

    function validateAdmin() {
        const password = document.getElementById('adminPassword').value;
        if (password === '1234') {
            sessionStorage.setItem('isAdmin', 'true');
            isAdmin = true;
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            showSection('userList');
        } else alert('Wrong password!');
    }

    function logoutAdmin() {
        sessionStorage.removeItem('isAdmin');
        isAdmin = false;
        window.location.reload();
    }

    function showSection(section) {
        ['userList', 'addUserSection', 'winnerList', 'winnerSection'].forEach(sec =>
            document.getElementById(sec).classList.add('hidden')
        );
        document.getElementById(section).classList.remove('hidden');
        renderData();
    }

    function addUser() {
        const name = document.getElementById('userName').value.trim();
        const mobile = document.getElementById('userMobile').value.trim();
        if (!name || !/^\d{10}$/.test(mobile)) return alert('Invalid Name or Mobile!');
        const newCoupon = 'MPB-' + String(users.length + 1001);
        users.push({ name, mobile, coupon: newCoupon });
        localStorage.setItem('users', JSON.stringify(users));
        renderData();
        alert(`User added! Coupon: ${newCoupon}`);
    }

    function drawWinner() {
        if (users.length === 0) return alert('No users to draw from!');
        showSection('winnerSection');
        const winnerIndex = Math.floor(Math.random() * users.length);
        const winner = users[winnerIndex];
        winners.push({ list: listNumber, ...winner });
        users.splice(winnerIndex, 1);
        localStorage.setItem('users', JSON.stringify(users));
        localStorage.setItem('winners', JSON.stringify(winners));
        localStorage.setItem('listNumber', ++listNumber);
        confetti();
        document.getElementById('winnerDisplay').innerText = `${winner.name} (Coupon: ${winner.coupon})`;
        renderData();
    }

    function resetData() {
        if (!confirm('Reset all data?')) return;
        localStorage.clear();
        users = [];
        winners = [];
        listNumber = 1;
        renderData();
    }

    function renderData() {
        const userTableBody = document.getElementById('userTableBody');
        userTableBody.innerHTML = users.map((u, i) =>
            `<tr><td>${i + 1}</td><td>${u.name}</td><td>${u.coupon}</td></tr>`
        ).join('');

        const winnersTableBody = document.getElementById('winnersTableBody');
        winnersTableBody.innerHTML = winners.map((w, i) =>
            `<tr><td>${w.list}</td><td>${w.name}</td><td>${w.coupon}</td></tr>`
        ).join('');
    }

    function exportToCSV(type) {
        const data = type === 'users' ? users : winners;
        const csv = data.map(row => Object.values(row).join(",")).join("\n");
        const link = document.createElement('a');
        link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
        link.download = `${type}.csv`;
        link.click();
    }

    function confetti() {
        window.confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    }

    if (isAdmin) showSection('userList');
</script>

</body>
</html>
